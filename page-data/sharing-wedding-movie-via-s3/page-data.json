{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/sharing-wedding-movie-via-s3/",
    "result": {"data":{"site":{"siteMetadata":{"title":"joe-yamaの備忘録ブログ"}},"markdownRemark":{"id":"53dee3c9-4bf2-51da-b2b4-5e70b65eb9ea","excerpt":"10GB超の動画をどのように共有するか 友人の結婚式で動画を撮りまくっていたら、合計10GBを超えてしまっていた。（最近カメラを買ったので、、、）\nGoogleフォトに保存して共有すればいいや、と楽観視していましたが問題発生。 Googleフォトに無料で保存できるのは1アカウント15GB…","html":"<h2 id=\"10gb超の動画をどのように共有するか\" style=\"position:relative;\"><a href=\"#10gb%E8%B6%85%E3%81%AE%E5%8B%95%E7%94%BB%E3%82%92%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E5%85%B1%E6%9C%89%E3%81%99%E3%82%8B%E3%81%8B\" aria-label=\"10gb超の動画をどのように共有するか permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10GB超の動画をどのように共有するか</h2>\n<p>友人の結婚式で動画を撮りまくっていたら、合計10GBを超えてしまっていた。（最近カメラを買ったので、、、）\nGoogleフォトに保存して共有すればいいや、と楽観視していましたが問題発生。</p>\n<p><a href=\"https://support.google.com/photos/answer/6220791?hl=ja\">Googleフォトに無料で保存できるのは1アカウント15GBまで</a>というのを忘れていました。\nすでに使用している容量と合計すると15GBを超えてしますので、Googleフォトに頼るのは難しそうです。</p>\n<h2 id=\"s3が動画の保存先共有の解決策に\" style=\"position:relative;\"><a href=\"#s3%E3%81%8C%E5%8B%95%E7%94%BB%E3%81%AE%E4%BF%9D%E5%AD%98%E5%85%88%E5%85%B1%E6%9C%89%E3%81%AE%E8%A7%A3%E6%B1%BA%E7%AD%96%E3%81%AB\" aria-label=\"s3が動画の保存先共有の解決策に permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>S3が動画の保存先＆共有の解決策に</h2>\n<p>GoogleOneで追加容量を購入する手やDropBoxなど他のファイル共有サービスを利用する手も考えましたが、コストパフォーマンスが良くないので却下しました。\n大容量の動画をバンバン保存するために使うのは贅沢すぎます。</p>\n<p>ストレージとして考えたらS3のほうが幾分か安そうです。ついでにストレージクラスを下げておけば、さらに安くなりますよね。あれ？これからは撮った動画をS3にどんどん打ち込んでおけばよいのではという発想に至りました。</p>\n<p>記事の主題からは外れますが、撮った動画をどこに保存していくか、ということも最近の悩みのタネでした。\n思い出が消えてしまうのは悲しいので何枚かハードディスクを買ってRAIDを組もうと思っていましたが、S3がこの悩みの解決策にもなりそうです。</p>\n<h2 id=\"署名付きurlで安全に共有\" style=\"position:relative;\"><a href=\"#%E7%BD%B2%E5%90%8D%E4%BB%98%E3%81%8Durl%E3%81%A7%E5%AE%89%E5%85%A8%E3%81%AB%E5%85%B1%E6%9C%89\" aria-label=\"署名付きurlで安全に共有 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>署名付きURLで安全に共有</h2>\n<p>もちろん友人の結婚式の動画ですからパブリックに公開なんてしたくありません。そこで<a href=\"https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/ShareObjectPreSignedURL.html\">S3の署名付きURL</a>を利用します。</p>\n<p>適当にバケットを作成して、動画をアップロードします。</p>\n<p>面倒なのですが、その性質上オブジェクトごとに署名付きURLを発行する必要があるので、指定のPrefixにあるオブジェクトすべての事前署名付きURLを発行し、テキストに保存します。</p>\n\n        <div class=\"gatsby-code-title\">\n          <span>bash</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws s3 <span class=\"token function\">ls</span> --recursive s3://my-s3-bucket/2022-04-23-結婚式/ <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $NF}'</span> <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> -I <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> aws s3 presign s3://my-s3-bucket/<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> --expires-in <span class=\"token number\">604800</span> <span class=\"token operator\">></span> presign-urls.txt</code></pre></div>\n<p>あとは<code class=\"language-text\">presign-urls.txt</code>を友人に共有すればOKです。</p>\n<p><code class=\"language-text\">--expires-in</code>で署名が失効するまでの時間（秒単位）を指定することができます。最大は604800（1週間）のようです。<strong>（←ハマリポイントあり。追記参照）</strong></p>\n<h1 id=\"追記署名付き-url-が指定した有効期限より前に失効してしまう\" style=\"position:relative;\"><a href=\"#%E8%BF%BD%E8%A8%98%E7%BD%B2%E5%90%8D%E4%BB%98%E3%81%8D-url-%E3%81%8C%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E6%9C%89%E5%8A%B9%E6%9C%9F%E9%99%90%E3%82%88%E3%82%8A%E5%89%8D%E3%81%AB%E5%A4%B1%E5%8A%B9%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%86\" aria-label=\"追記署名付き url が指定した有効期限より前に失効してしまう permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>追記：署名付き URL が指定した有効期限より前に失効してしまう</h1>\n<p>友人に共有したURLからダウンロードしてもらいたいので、URLの有効期限（<code class=\"language-text\">expires-in</code>）は最大値の１週間を設定していました。\nですが、次の日URLが無効になっていると友人連絡がありました。</p>\n<p>URL先ではこんな表示が。</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Code</span><span class=\"token punctuation\">></span></span>AccessDenied<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Code</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Message</span><span class=\"token punctuation\">></span></span>Request has expired<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Message</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>1週間の有効期限を設定したのに翌日に期限切れになってしまってます。</p>\n<h3 id=\"原因\" style=\"position:relative;\"><a href=\"#%E5%8E%9F%E5%9B%A0\" aria-label=\"原因 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原因</h3>\n<p>AWSのナレッジセンターに以下のような記事を見つけました。</p>\n<blockquote>\n<p>一時トークンを使用して署名済み URL を作成した場合は、トークンが失効すると URL も失効します。それより後の有効期限を指定して URL を作成した場合でも、URL は失効します。<br>\n<a href=\"https://aws.amazon.com/jp/premiumsupport/knowledge-center/presigned-url-s3-bucket-expiration/\">Amazon S3 バケットの署名付き URL が、指定した有効期限より前に失効するのはなぜですか?</a></p>\n</blockquote>\n<p>署名付きURLを発行したのはIAM Roleだったので、AssumeRoleしたときの一時トークンの有効期限が過ぎてしまうと、事前署名付きURLも執行してしまうようです。</p>\n<p>AssumeRoleの一時トークンの有効期限はというと、デフォルトでは1時間（最大でも12時間）とのこと。</p>\n<blockquote>\n<p>パラメータを渡さない場合、一時的な認証情報の有効期限は 1 時間です。<br>\n<a href=\"https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_credentials_temp_request.html\">AssumeRole—クロスアカウントの委任とカスタム ID ブローカーを経由したフェデレーション</a></p>\n</blockquote>\n<p>したがって、IAM RoleをPrincipalが事前署名する場合、12時間以上の有効期限は実質設定不可能なのです。</p>\n<h2 id=\"対処法\" style=\"position:relative;\"><a href=\"#%E5%AF%BE%E5%87%A6%E6%B3%95\" aria-label=\"対処法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>対処法</h2>\n<p>これもナレッジセンターに書かれていました。</p>\n<blockquote>\n<p>最長 7 日間有効の署名付き URL を作成するには、SDK に対する IAM ユーザー認証情報 (アクセスキーとシークレットアクセスキー) を指定します。その後、AWS 署名バージョン 4 を使用して署名付き URL を生成します。<br>\n<a href=\"https://aws.amazon.com/jp/premiumsupport/knowledge-center/presigned-url-s3-bucket-expiration/\">Amazon S3 バケットの署名付き URL が、指定した有効期限より前に失効するのはなぜですか?</a></p>\n</blockquote>\n<p>最長 7 日間有効の署名付き URL を作成するには、IAMユーザーが署名する必要があるようです。</p>\n<p>事前署名付きURL発行の仕組みを考慮すれば確かにそうなるのですが、ハマリポイントなので注意です。</p>","frontmatter":{"title":"友人の結婚式の動画をS3経由で共有する","date":"April 27, 2022","description":"プライベートでの大容量ファイルの共有はこれでよさそう"}},"previous":{"fields":{"slug":"/remap-handmade-keyboard/"},"frontmatter":{"title":"自作キーボードのキーマップを変更する"}},"next":null},"pageContext":{"id":"53dee3c9-4bf2-51da-b2b4-5e70b65eb9ea","previousPostId":"f792b167-8930-5df7-9622-25935eda252e","nextPostId":null}},
    "staticQueryHashes": ["2841359383","3257411868"]}